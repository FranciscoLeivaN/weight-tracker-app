name: Pruebas de Rendimiento

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  artillery-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          
      - name: Instalar dependencias
        run: npm ci
        
      - name: Construir la aplicación
        run: npm run build
        
      - name: Ejecutar pruebas de rendimiento
        run: |
          npm install -g artillery
          npm run serve &
          sleep 5
          artillery run artillery/performance-test.yml -o artillery-report.json
          node artillery/show-results.js artillery-report.json
        
      - name: Guardar informe de rendimiento
        uses: actions/upload-artifact@v4
        with:
          name: artillery-performance-report
          path: |
            artillery-report.json
            
      - name: Verificar umbrales de rendimiento
        run: |
          # Extraer métricas clave del informe
          MEAN_RESPONSE_TIME=$(jq '.aggregate.latency.mean' artillery-report.json)
          P95_RESPONSE_TIME=$(jq '.aggregate.latency.p95' artillery-report.json)
          ERROR_RATE=$(jq '.aggregate.errors.rate' artillery-report.json)
          
          echo "Tiempo de respuesta medio: ${MEAN_RESPONSE_TIME}ms"
          echo "Tiempo de respuesta P95: ${P95_RESPONSE_TIME}ms"
          echo "Tasa de error: ${ERROR_RATE}%"
          
          # Comprobar umbrales
          if (( $(echo "$MEAN_RESPONSE_TIME > 200" | bc -l) )); then
            echo "⚠️ Advertencia: El tiempo de respuesta medio supera los 200ms"
          fi
          
          if (( $(echo "$P95_RESPONSE_TIME > 500" | bc -l) )); then
            echo "⚠️ Advertencia: El tiempo de respuesta P95 supera los 500ms"
          fi
          
          if (( $(echo "$ERROR_RATE > 1" | bc -l) )); then
            echo "❌ Error: La tasa de error supera el 1%"
            exit 1
          fi
      
      - name: Resumen de rendimiento
        run: |
          echo "## Resumen de la prueba de rendimiento" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha de ejecución:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Tiempo de ejecución:** $(cat artillery-report.json | jq -r '.duration // "N/A"')s" >> $GITHUB_STEP_SUMMARY
          echo "- **Tiempo de respuesta medio:** ${MEAN_RESPONSE_TIME}ms" >> $GITHUB_STEP_SUMMARY
          echo "- **Tiempo de respuesta P95:** ${P95_RESPONSE_TIME}ms" >> $GITHUB_STEP_SUMMARY
          echo "- **Tasa de error:** ${ERROR_RATE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **[Ver informe JSON](../artifacts/artillery-performance-report/artillery-report.json)**" >> $GITHUB_STEP_SUMMARY
